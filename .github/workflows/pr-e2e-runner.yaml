name: SDK PR Notebook E2E Runner

on:
  # Listen for the dispatch event sent by the source repository
  repository_dispatch:
    types: [run-sdk-pr-e2e-tests]
  workflow_dispatch:
    inputs:
      sdk_sha:
        description: 'SHA of the SDK PR branch head'
        required: true
        default: 'dummy-sha-for-test'
      sdk_repo:
        description: 'Name of the SDK repo (owner/repo)'
        required: true
        default: 'kubeflow/sdk-repo'
      training_operator_repo_owner:
        description: 'Owner of the training operator repo'
        required: true
        default: 'kubeflow/training-operator'
      training_operator_repo_name:
        description: 'Name of the training operator repo'
        required: true
        default: 'training-operator'
      training_operator_ref:
        description: 'Ref of the training operator repo'
        required: true
        default: 'dev'

jobs:
  run-notebook-test:
    runs-on: kubeflow-devx-testing
    permissions:
      contents: write # Needed to upload the executed notebook artifact
    
    steps:
      - name: Checkout SDK PR Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.sdk_repo }}
          ref: ${{ github.event.client_payload.sdk_sha }}
          path: sdk-repo # Checkout the SDK code into a subdirectory

      - name: Checkout Training Operator Repo (Test Asset)
        uses: actions/checkout@v4
        with:
          # Use the training_operator_* keys from the client-payload
          repository: ${{ github.event.client_payload.training_operator_repo_owner }}/${{ github.event.client_payload.training_operator_repo_name }}
          ref: ${{ github.event.client_payload.training_operator_ref }}
          path: training-operator-repo # Checkout the Training Operator code into a subdirectory
          
      # Test Environment Setup
      - name: Set up Python 3.9
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Setup Environment and Install Dependencies
        shell: bash
        run: |
          echo "Installing tools and dependencies..."
          
          # 1. Install Poetry and Papermill tools
          pip install poetry
          pip install papermill==2.6.0 jupyter==1.1.1 ipykernel==6.29.5

          # 2. Install SDK dependencies using Poetry (reading pyproject.toml)
          cd sdk-repo
          poetry install -r --with dev
          
          # Get VENV path for later use
          POETRY_VENV_PATH=$(poetry env info --path)
          
          # 3. Configure Notebook Kernel for Papermill
          $POETRY_VENV_PATH/bin/python -m ipykernel install --user --name=sdk-test-kernel --display-name "Python (SDK Test)"
          
          # 4. Install Runner Script Dependencies (if any)
          cd ..           
          mkdir -p artifacts/notebooks # Create artifact directory

      - name: Run E2E Notebook Test with Papermill
        id: run-test
        run: |
          # Use Poetry to find the correct binary paths
          POETRY_VENV_PATH=$(cd sdk-repo && poetry env info --path)
          PAPERMILL_BIN="$POETRY_VENV_PATH/bin/papermill"

          echo "Using Papermill from: $PAPERMILL_BIN"
          
          NOTEBOOK_INPUT="training-operator-repo/examples/pytorch/image-classification/mnist.ipynb" 
          NOTEBOOK_OUTPUT="artifacts/notebooks/sdk-pr-test-output.ipynb"
          TIMEOUT_SECONDS=900 
          
          echo "Executing notebook for SDK commit: ${{ github.event.client_payload.sdk_sha }}"
          
          # Execute the notebook using the virtual environment where the SDK is installed
          $PAPERMILL_BIN $NOTEBOOK_INPUT $NOTEBOOK_OUTPUT \
            --kernel "sdk-test-kernel" \
            --parameters timeout $TIMEOUT_SECONDS \
            --log-level INFO
          
          echo "Notebook test execution finished."

      - name: Upload Executed Notebook Artifact
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: sdk-pr-notebook-result-${{ github.event.client_payload.sdk_sha }}
          path: artifacts/notebooks/sdk-pr-test-output.ipynb
          retention-days: 1