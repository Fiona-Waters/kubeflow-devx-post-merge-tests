name: SDK PR Notebook E2E Runner

on:
  repository_dispatch:
    types: [run-sdk-pr-e2e-tests]

jobs:
  run-notebook-test:
    runs-on: ubuntu-latest 
    permissions:
      contents: write 
    
    steps:
      - name: Checkout SDK PR Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.sdk_repo }}
          ref: ${{ github.event.client_payload.sdk_sha }}
          path: sdk-repo # Checkout the SDK code into a subdirectory

      - name: Checkout Training Operator Repo (Test Asset)
        uses: actions/checkout@v4
        with:
          repository: opendatahub-io/trainer
          ref: main
          path: training-operator-repo # Checkout the Training Operator code into a subdirectory
          
      # --- Test Environment Setup ---
      - name: Set up Python 3.9
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Setup Environment and Install Dependencies
        shell: bash
        run: |
          echo "Installing tools and dependencies..."
          
          # 1. Install Papermill and core execution tools
          pip install papermill==2.6.0 jupyter==1.1.1 ipykernel==6.29.5
          
          # 2. Install main dependencies (Manually listed from pyproject.toml [project.dependencies])
          # This ensures the SDK's environment is fully configured.
          echo "Installing main SDK dependencies..."
          pip install kubernetes>=27.2.0 pydantic>=2.10.0 kubeflow-trainer-api>=2.0.0 kubeflow-katib-api>=0.19.0

          # 3. Install the SDK Code itself in editable mode
          # '-e .' installs the package from pyproject.toml in editable mode.
          # '[dev]' ensures optional dev dependencies are also installed.
          cd sdk-repo
          echo "Installing SDK PR code in editable mode..."
          # This command reads the dependencies from pyproject.toml and installs them.
          pip install -e .[dev] 
          
          # 4. Configure Notebook Kernel
          PYTHON_BIN=$(which python)
          $PYTHON_BIN -m ipykernel install --user --name=sdk-test-kernel --display-name "Python (SDK Test)"
          
          cd .. 
          mkdir -p artifacts/notebooks # Create artifact directory

      - name: Run E2E Notebook Test with Papermill (Local)
        id: run-test
        env:
          # Force local execution and disable Kubernetes autodetection
          TRAINER_BACKEND: local
          KUBERNETES_SERVICE_HOST: ""
        run: |
          # Use the python executable where Papermill was installed
          PAPERMILL_BIN=$(which papermill)
          echo "Using Papermill from: $PAPERMILL_BIN"

          # Set the notebook paths
          NOTEBOOK_INPUT="training-operator-repo/examples/pytorch/image-classification/mnist.ipynb"
          NOTEBOOK_OUTPUT="artifacts/notebooks/sdk-pr-test-output.ipynb"
          TIMEOUT_SECONDS=900 

          echo "Executing notebook: $NOTEBOOK_INPUT"

          # Ensure the output directory exists
          mkdir -p "$(dirname "$NOTEBOOK_OUTPUT")"

          # Execute the notebook using Papermill in local mode
          $PAPERMILL_BIN "$NOTEBOOK_INPUT" "$NOTEBOOK_OUTPUT" \
            --kernel "sdk-test-kernel" \
            --log-output \
            --log-level INFO

          echo " Notebook test execution finished successfully."


      - name: Upload Executed Notebook Artifact
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: sdk-pr-notebook-result-${{ github.event.client_payload.sdk_sha }}
          path: artifacts/notebooks/sdk-pr-test-output.ipynb
          retention-days: 1